<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <title>X Sentinel - Main</title>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-left">
            <span id="username">Usuário</span>
        </div>
        <div class="navbar-right">
            <button id="logout-button" class="btn-logout">Sair</button>
        </div>
    </nav>
    <div class="content">
        <div class="main-container">
            <div class="client-section">
                <h1>Selecione o cliente</h1>
                <div class="client-container">
                    <!-- Os clientes serão inseridos aqui -->
                </div>
            </div>
            <div class="iframe-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <script>
        document.getElementById('logout-button').addEventListener('click', function() {
            localStorage.clear();
            window.location.href = '/';
        });

        window.onload = function() {
            const token = localStorage.getItem('token');
            const nome = localStorage.getItem('nome');
            
            if (token && nome) {
                document.getElementById('username').innerText = nome;
            } else {
                window.location.href = '/';
            }

            plotarClientes();
            initializeMap();
        };

        function plotarClientes() {
            const clientContainer = document.querySelector('.client-container');
            clientContainer.innerHTML = '';

            fetch('/clientes', {
                headers: {
                    "x-access-token": localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log(data)
                const locations = [];
                data.forEach(cliente => {
                    const clientCard = document.createElement('div');
                    clientCard.classList.add('client-card');

                    const fotoUrl = cliente.foto_url ? cliente.foto_url : 'https://i.pinimg.com/474x/cf/4a/c1/cf4ac168846158fc8dca8e80adf2e264.jpg';

                    clientCard.innerHTML = `
                        <div class="client-card-inner">
                            <img src="${fotoUrl}" alt="Cliente">
                            <div class="client-info">
                                <h3>${cliente.nome}</h3>
                                <p class='residencia'>${cliente.residencia}</p>
                                <p class='bairro'>${cliente.bairro}</p>
                                <p class='cidade'>${cliente.cidade} - ${cliente.estado}</p>
                            </div>
                        </div>
                    `;
                    clientCard.addEventListener('click', () => {
                        window.location.href = `residencia/${cliente.residencia_id}`;
                    });
                    clientContainer.appendChild(clientCard);

                    if (cliente.latitude && cliente.longitude) {
                        locations.push([cliente.latitude, cliente.longitude, cliente.nome]);
                    }
                });
                updateMap(locations);
            });
        }

        function initializeMap() {
            window.map = L.map('map').setView([-23.55052, -46.633308], 10); // Initial view centered on Brazil

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(window.map);
        
            const southWest = L.latLng(-33.75, -73.6);
            const northEast = L.latLng(5.25, -34.75);
            const bounds = L.latLngBounds(southWest, northEast);
        
            map.fitBounds(bounds); 
        }

        function updateMap(locations) {
            if (window.map) {
                locations.forEach(location => {
                    L.marker([location[0], location[1]]).addTo(window.map)
                        .bindPopup(location[2]);
                });
            }
        }
    </script>
</body>
</html>
